<!-- assign-slot.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Assign Warehouse Slot</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>
<style>
  body {
    font-family: 'Segoe UI', Arial, sans-serif;
    background: linear-gradient(120deg, #f8fafc 0%, #e0e7ff 100%);
    margin: 0;
    padding: 0;
    min-height: 100vh;
  }

  h1 {
    text-align: center;
    margin-top: 40px;
    color: #3730a3;
    letter-spacing: 1px;
    font-size: 2.2rem;
    text-shadow: 0 2px 8px #c7d2fe80;
    transition: color 0.3s;
  }

  table {
    margin: 40px auto;
    border-collapse: separate;
    border-spacing: 0;
    background: #fff;
    border-radius: 18px;
    box-shadow: 0 6px 32px #6366f180, 0 1.5px 4px #6366f120;
    overflow: hidden;
    min-width: 700px;
    transition: box-shadow 0.4s;
  }

  th, td {
    padding: 18px 28px;
    text-align: center;
    font-size: 1.08rem;
    transition: background 0.3s, color 0.3s;
  }

  th {
    background: #6366f1;
    color: #fff;
    font-weight: 600;
    letter-spacing: 0.5px;
    border-bottom: 2px solid #818cf8;
    transition: background 0.3s;
  }

  tr {
    transition: background 0.3s;
  }

  tr:hover td {
    background: #eef2ff;
    transition: background 0.3s;
  }

  td {
    color: #373737;
    border-bottom: 1px solid #e0e7ff;
  }

  select {
    padding: 7px 18px;
    border-radius: 8px;
    border: 1px solid #a5b4fc;
    background: #f1f5ff;
    color: #3730a3;
    font-size: 1rem;
    outline: none;
    transition: border 0.3s, box-shadow 0.3s;
    box-shadow: 0 1px 4px #6366f120;
  }

  select:focus {
    border: 1.5px solid #6366f1;
    box-shadow: 0 2px 8px #6366f140;
  }

  option:disabled {
    color: #a1a1aa;
    background: #f3f4f6;
  }

  button {
    padding: 8px 22px;
    border-radius: 8px;
    border: none;
    background: linear-gradient(90deg, #6366f1 60%, #818cf8 100%);
    color: #fff;
    font-weight: 600;
    font-size: 1rem;
    cursor: pointer;
    box-shadow: 0 2px 8px #6366f140;
    transition: background 0.3s, transform 0.2s, box-shadow 0.3s;
    outline: none;
  }

  button:hover, button:focus {
    background: linear-gradient(90deg, #818cf8 60%, #6366f1 100%);
    transform: translateY(-2px) scale(1.04);
    box-shadow: 0 6px 24px #6366f140;
  }

  /* Row fade-in animation */
  tbody tr {
    opacity: 0;
    transform: translateY(30px);
    animation: fadeInRow 0.7s cubic-bezier(.4,2,.6,1) forwards;
  }
  tbody tr:nth-child(1) { animation-delay: 0.05s; }
  tbody tr:nth-child(2) { animation-delay: 0.12s; }
  tbody tr:nth-child(3) { animation-delay: 0.19s; }
  tbody tr:nth-child(4) { animation-delay: 0.26s; }
  tbody tr:nth-child(5) { animation-delay: 0.33s; }
  tbody tr:nth-child(6) { animation-delay: 0.40s; }
  tbody tr:nth-child(7) { animation-delay: 0.47s; }
  tbody tr:nth-child(8) { animation-delay: 0.54s; }
  tbody tr:nth-child(9) { animation-delay: 0.61s; }
  tbody tr:nth-child(10) { animation-delay: 0.68s; }

  @keyframes fadeInRow {
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>
<body>
  <h1>Assign Slot to Booking</h1>
   <div style="text-align: center; margin-top: 20px;">
    <button onclick="goBack()"> ⬅️ Back to Dashboard</button>

  <div style="text-align: center; margin-top: 10px;">
  <button onclick="goToIssueKeys()"> ➡️ Assign Keys</button>
</div>

  <div style="text-align: center; margin-top: 10px;">
  <button onclick="goToReturnKeys()"> ➡️ Return Issued Keys</button>
</div>
 
  <table border="1">
    <thead>
      <tr>
        <th>Booking ID</th>
        <th>Customer</th>
        <th>Select Slot</th>
        <th>Assign</th>
      </tr>
    </thead>
    <tbody id="assignTable"></tbody>
  </table>

 <script>
  
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const slots = Array.from({length: 20}, (_, i) => `W-${String(i + 1).padStart(3, '0')}`);
  const table = document.getElementById('assignTable');

  db.ref('StorageBookings').once('value')
    .then(snapshot => {
      const data = snapshot.val();
      console.log("StorageBookings data:", data);

      if (!data) {
        table.innerHTML = `<tr><td colspan="4">No bookings found</td></tr>`;
        return;
      }

      const assigned = new Set();
      Object.values(data).forEach(b => {
        if (b.slotAssigned && b.keyStatus !== 'Returned') {
          assigned.add(b.slotAssigned);
        }
      });

      let index = 0;
      Object.entries(data).forEach(([id, b]) => {
        if (!b.slotAssigned) {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${id}</td>
            <td>${b.fullName || 'N/A'}</td>
            <td>
              <select id="slot-${index}">
                <option value="">Select Slot</option>
                ${slots.map(slot => 
                  `<option value="${slot}" ${assigned.has(slot) ? 'disabled' : ''}>${slot}</option>`
                ).join('')}
              </select>
            </td>
            <td>
              <button onclick="assignSlot('${id}', ${index})">Assign</button>
            </td>
          `;
          table.appendChild(row);
          index++;
        }
      });

      if (index === 0) {
        table.innerHTML = `<tr><td colspan="4">All bookings already have slots assigned.</td></tr>`;
      }
    })
    .catch(error => {
      console.error("Error fetching StorageBookings:", error);
      table.innerHTML = `<tr><td colspan="4">Error loading bookings. Check console.</td></tr>`;
    });

  function assignSlot(id, index) {
    const slot = document.getElementById(`slot-${index}`).value;
    if (!slot) return alert('Please select a slot!');
    const keyId = slot.replace('W-', 'K-');

    db.ref('StorageBookings/' + id).update({
      slotAssigned: slot,
      keyId: keyId,
      status: 'Slot Assigned',
      keyStatus: 'Not Issued'
    }).then(() => {
      alert(`Assigned ${slot} and Key ${keyId} to booking ${id}`);
      location.reload();
    }).catch(err => {
      console.error("Error assigning slot:", err);
      alert("Failed to assign slot.");
    });
  }
  function goToReturnKeys() {
    window.location.href = 'returnkey.html'; // Adjust the path as needed
  }
  function goToIssueKeys() {
    window.location.href = 'assignkey.html'; // Adjust the path as needed
  }
  function goBack() {
    window.location.href = 'admindashboard.html'; // Adjust the path as needed
  }
</script>

</body>
</html>
